"use strict";!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){var t=function(t,n){var n=n||e(t.imageBox),i={state:{},ratio:1,options:t,imageBox:n,thumbBox:n.find(t.thumbBox),spinner:n.find(t.spinner),image:new Image,getDataURL:function(){var e=this.thumbBox.width(),t=this.thumbBox.height(),i=document.createElement("canvas"),o=n.css("background-position").split(" "),a=n.css("background-size").split(" "),s=parseInt(o[0])-n.width()/2+e/2,r=parseInt(o[1])-n.height()/2+t/2,u=parseInt(a[0]),c=parseInt(a[1]),d=parseInt(this.image.height),m=parseInt(this.image.width);i.width=e,i.height=t;var h=i.getContext("2d");h.drawImage(this.image,0,0,m,d,s,r,u,c);var g=i.toDataURL("image/png");return g},getBlob:function(){for(var e=this.getDataURL(),t=e.replace("data:image/png;base64,",""),n=atob(t),i=[],o=0;o<n.length;o++)i.push(n.charCodeAt(o));return new Blob([new Uint8Array(i)],{type:"image/png"})},zoomIn:function(){this.ratio*=1.1,o()},zoomOut:function(){this.ratio*=.9,o()},changeSize:function(e){this.ratio=1+e,o()}},o=function(){var e=parseInt(i.image.width)*i.ratio,t=parseInt(i.image.height)*i.ratio,o=(n.width()-e)/2,a=(n.height()-t)/2;n.css({"background-image":"url("+i.image.src+")","background-size":e+"px "+t+"px","background-position":o+"px "+a+"px","background-repeat":"no-repeat"})},a=function(e){e.stopImmediatePropagation(),i.state.dragable=!0,i.state.mouseX=e.clientX,i.state.mouseY=e.clientY},s=function(e){if(e.stopImmediatePropagation(),i.state.dragable){var t=e.clientX-i.state.mouseX,o=e.clientY-i.state.mouseY,a=n.css("background-position").split(" "),s=t+parseInt(a[0]),r=o+parseInt(a[1]);n.css("background-position",s+"px "+r+"px"),i.state.mouseX=e.clientX,i.state.mouseY=e.clientY}},r=function(e){e.stopImmediatePropagation(),i.state.dragable=!1},u=function(e){e.originalEvent.wheelDelta>0||e.originalEvent.detail<0?i.ratio*=1.1:i.ratio*=.9,o()},c=function(e){var t=e.changedTouches,n=t[0],i="";switch(e.type){case"touchstart":i="mousedown";break;case"touchmove":i="mousemove";break;case"touchend":i="mouseup";break;default:return}var o=document.createEvent("MouseEvent");o.initMouseEvent(i,!0,!0,window,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(o),e.preventDefault()};return i.spinner.show(),i.image.onload=function(){i.spinner.hide(),o(),n.unbind("mousedown"),n.unbind("mousemove"),e(window).unbind("mouseup"),n.unbind("mousewheel DOMMouseScroll"),n.bind("mousedown",a),n.bind("mousemove",s),e(window).bind("mouseup",r),n.bind("mousewheel DOMMouseScroll",u),n[0].removeEventListener("touchstart",c,!0),n[0].removeEventListener("touchmove",c,!0),n[0].removeEventListener("touchend",c,!0),n[0].removeEventListener("touchcancel",c,!0),n[0].addEventListener("touchstart",c,!0),n[0].addEventListener("touchmove",c,!0),n[0].addEventListener("touchend",c,!0),n[0].addEventListener("touchcancel",c,!0)},i.image.src=t.imgSrc,n.on("remove",function(){e(window).unbind("mouseup",r)}),i};jQuery.fn.cropbox=function(e){return new t(e,this)}});